I"¢D<p>In this project, weâ€™re going to build a simple Long Short Term Memory (LSTM)-based recurrent model from scratch, using NumPy.</p>

<p>Weâ€™ll employ the LSTM model on the same task as our previous RNN model, and find out which model produces better song lyrics.</p>

<p>Given the foundational knowledge on RNNs established in previous projects, weâ€™ll move relatively quickly into the theory for LSTMs.</p>

<p>Hereâ€™s the structure for this project post:</p>

<p>1. LSTM Overview</p>

<p>2. Describing the LSTM mathematically</p>

<p>2.1 Forward Propagation</p>

<p>2.2 Backward Propagation</p>

<p>2.2.1 Deriving Components In Backpropagation Through Time</p>

<p>2.3 How LSTMs Solve Vanishing/Exploding Gradients</p>

<p>3. Code Implementation &amp; Results</p>

<h2 id="1-lstm-overview">1. LSTM Overview</h2>

<p>In this section, weâ€™ll cover the architecture of the LSTM cell, and examine how it improves upon the basic RNN model we learned in the previous project post. In order to do that, weâ€™ll have a super quick review of RNNs, and modify our visual perspective of RNNs just a little.</p>

<p>Recall that RNNs are a special type of neural network consisting of recursive computational loops that span adjacent time steps. We visualized them unfolding like this:</p>

<div class="md-image-container">
    <img class="post-image" src="/assets/images/rnn_2.png" height="auto" width="75%" />
</div>

<p>Also, recall that our RNN has biases and activation functions. We described the net input to node h as $z_h^{&lt;t&gt;}$, and the activation at node $h$ as $h^{&lt;t&gt;}$, like so:</p>

<p>$\text{Net Input to Node h:}$</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><menclose notation="box"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="true"><mrow><msubsup><mi>z</mi><mi>h</mi><mrow><mo>&lt;</mo><mi>t</mi><mo>&gt;</mo></mrow></msubsup><mo>=</mo><msub><mi>W</mi><mrow><mi>h</mi><mi>x</mi></mrow></msub><msup><mi>x</mi><mrow><mo>&lt;</mo><mi>t</mi><mo>&gt;</mo></mrow></msup><mo>+</mo><msub><mi>W</mi><mrow><mi>h</mi><mi>h</mi></mrow></msub><msup><mi>h</mi><mrow><mo>&lt;</mo><mi>t</mi><mo>âˆ’</mo><mn>1</mn><mo>&gt;</mo></mrow></msup><mo>+</mo><msub><mi>b</mi><mi>h</mi></msub></mrow></mstyle></mstyle></mstyle></menclose></mrow><annotation encoding="application/x-tex"> 
\boxed{z_h^{&lt;t&gt;} = W_{hx} x^{&lt;t&gt;} + W_{hh} h^{&lt;t-1&gt;} + b_h}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.8045859999999998em;vertical-align:-0.6004779999999998em;"></span><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.204108em;"><span style="top:-3.8045859999999996em;"><span class="pstrut" style="height:3.8045859999999996em;"></span><span class="boxpad"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-2.439522em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathdefault mtight">t</span><span class="mrel mtight">&gt;</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.260478em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathdefault mtight">t</span><span class="mrel mtight">&gt;</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathdefault mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span><span class="mrel mtight">&gt;</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.2041079999999997em;"><span class="pstrut" style="height:3.8045859999999996em;"></span><span class="stretchy fbox" style="height:1.8045859999999998em;border-style:solid;border-width:0.04em;"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.6004779999999998em;"><span></span></span></span></span></span></span></span></span></span></p>

<p>$\text{Activation at Node h:}$</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><menclose notation="box"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi>h</mi><mrow><mo>&lt;</mo><mi>t</mi><mo>&gt;</mo></mrow></msup><mo>=</mo><msub><mi>Ïƒ</mi><mi>h</mi></msub><mo stretchy="false">(</mo><msubsup><mi>z</mi><mi>h</mi><mrow><mo>&lt;</mo><mi>t</mi><mo>&gt;</mo></mrow></msubsup><mo stretchy="false">)</mo></mrow></mstyle></mstyle></mstyle></menclose></mrow><annotation encoding="application/x-tex"> 
\boxed{h^{&lt;t&gt;} = \sigma_h (z_h^{&lt;t&gt;})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.784034em;vertical-align:-0.6004779999999998em;"></span><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.183556em;"><span style="top:-3.784034em;"><span class="pstrut" style="height:3.784034em;"></span><span class="boxpad"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathdefault mtight">t</span><span class="mrel mtight">&gt;</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-2.439522em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathdefault mtight">t</span><span class="mrel mtight">&gt;</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.260478em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><span style="top:-3.1835560000000003em;"><span class="pstrut" style="height:3.784034em;"></span><span class="stretchy fbox" style="height:1.784034em;border-style:solid;border-width:0.04em;"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.6004779999999998em;"><span></span></span></span></span></span></span></span></span></span></p>

<p>Where the activation function $\sigma_h$ used is usually the $\text{tanh}$ function.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Â </mtext><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex"> ~ \\ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mspace nobreak">Â </span></span><span class="mspace newline"></span></span></span></span></p>

<p>Now, to prepare for learning about LSTMs, weâ€™ll change our visual understanding of RNNs just a little. Now, weâ€™ll need to see RNNs as forming a chain of repeating modules, with a very simple structure, such as a single $\text{tanh}$ layer:</p>

<div class="md-image-container">
    <img class="post-image" src="/assets/images/lstm_1.png" height="auto" width="80%" />
</div>

<p>We can see that our node $h^{&lt;t&gt;}$ is now an â€œx-rayâ€ image of itself, where we can see how the its inputs map to its activation function, and to the outputs. Weâ€™ll be using this visual perspective when moving forward to learning about LSTMs next. Weâ€™ll also call the central node h as the â€œrepeating moduleâ€.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Â </mtext><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex"> ~ \\ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mspace nobreak">Â </span></span><span class="mspace newline"></span></span></span></span></p>

<p>LSTMs also have this chain-like structure, but the repeating module has a more complicated internal structure. Instead of the single $\text{tanh}$ neural network layer earlier, the LSTM repeating module has four:</p>

<div class="md-image-container">
    <img class="post-image" src="/assets/images/lstm_2.png" height="auto" width="80%" />
</div>

<p>Wow, things got complicated fast. Weâ€™ll go into more detail in the next few steps. But for now, the key takeaway is that we now have $\text{tanh}$ and sigmoid $\sigma$ activation functions in our repeating module. There is also also a new input/output at the top of the repeating module, giving us a total of three outputs - two outputs to the next repeating module, one output to node $y$ (colored in green).</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Â </mtext><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex"> ~ \\ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mspace nobreak">Â </span></span><span class="mspace newline"></span></span></span></span></p>

<p>Letâ€™s zoom into a single repeating module for now, and add some labels so we can describe each component. We call this a single LSTM cell:</p>

<div class="md-image-container">
    <img class="post-image" src="/assets/images/lstm_3.png" height="auto" width="80%" />
</div>

<p>Notice the Weight and Bias inputs for each activation block within the cell. We also see the activated outputs, $f$, $i$, $g$ and $o$. We also see our usual $h^{&lt;t-1&gt;}$, $x^{&lt;t&gt;}$ &amp; $h^{&lt;t&gt;}$ inputs and outputs. Finally, thereâ€™s also a new pair of I/O, in the form of $c^{&lt;t-1&gt;}$ and $c^{&lt;t&gt;}$.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Â </mtext><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex"> ~ \\ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mspace nobreak">Â </span></span><span class="mspace newline"></span></span></span></span></p>

<p>Weâ€™ll understand how the LSTM works by going through each core component. Letâ€™s begin with the new I/O, $c^{&lt;t-1&gt;}$ and $c^{&lt;t&gt;}$.</p>

<div class="md-image-container">
    <img class="post-image" src="/assets/images/lstm_4.png" height="auto" width="80%" />
</div>

<p>This component, called the â€œcell stateâ€, is actually the key to the LSTM architecture. It is shown as a horizontal line passing through the top of the LSTM cell, and it only goes through two minor linear interactions (as seen from the white pieces).</p>

<p>The cell state passes information through, and the LSTM has the ability to add or remove information to the cell state, via the linear interactions mentioned above.</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Â </mtext><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex"> ~ \\ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0em;vertical-align:0em;"></span><span class="mspace nobreak">Â </span></span><span class="mspace newline"></span></span></span></span></p>

<p>LSTMs control the addition and removal of information through â€œgatesâ€.</p>
:ET